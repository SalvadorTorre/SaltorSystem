"use strict";(self.webpackChunkSaltorSystem=self.webpackChunkSaltorSystem||[]).push([[93],{1093:(S,h,c)=>{c.r(h),c.d(h,{ModuloCuadreCaja:()=>$});var n=c(177),u=c(9417),l=c(8871),f=c(8032),d=c.n(f),F=c(5378),g=c(4941),m=c.n(g);class p{constructor(){this.yPos=20,this.doc=new F.default}iniciarDocumento(r){return this.doc.setFontSize(18),this.doc.text(r,14,this.yPos),this.yPos+=10,this.doc.setFontSize(12),this.doc.text(`Fecha de Impresi\xf3n: ${(new Date).toLocaleString()}`,14,this.yPos),this.yPos+=10,this}agregarDatosGenerales(r,e){return this.doc.setFontSize(10),this.doc.text(`Rango de Fechas: ${r}`,14,this.yPos),this.yPos+=6,e&&(this.doc.text(`Cajero: ${e}`,14,this.yPos),this.yPos+=6),this.yPos+=5,this}agregarTotales(r,e){this.doc.setFontSize(14),this.doc.text("Resumen de Valores Cobrados",14,this.yPos),this.yPos+=10,this.doc.setFontSize(12);return this.doc.text("Efectivo:",20,this.yPos),this.doc.text(`${e(r.efectivo)}`,60,this.yPos,{align:"right"}),this.yPos+=8,this.doc.text("Tarjeta:",20,this.yPos),this.doc.text(`${e(r.tarjeta)}`,60,this.yPos,{align:"right"}),this.yPos+=8,this.doc.text("Dep\xf3sito:",20,this.yPos),this.doc.text(`${e(r.deposito)}`,60,this.yPos,{align:"right"}),this.yPos+=8,this.doc.text("Cheque:",20,this.yPos),this.doc.text(`${e(r.cheque)}`,60,this.yPos,{align:"right"}),this.yPos+=10,this.doc.setFontSize(14),this.doc.setFont("helvetica","bold"),this.doc.text("TOTAL GENERAL:",14,this.yPos),this.doc.text(`${e(r.total)}`,60,this.yPos,{align:"right"}),this.doc.setFont("helvetica","normal"),this.yPos+=15,this}agregarTablaDetalle(r,e,a){const i=r.map(o=>[o.fa_codFact,new Date(o.fa_fecFact).toLocaleString(),o.fa_nomClie,e(Number(o.fa_valFact)),a?a(o.fa_fpago):o.fa_fpago]);return m()(this.doc,{startY:this.yPos,head:[["C\xf3digo Factura","Fecha","Nombre Cliente","Valor Factura","Forma Pago"]],body:i,theme:"grid",headStyles:{fillColor:[66,66,66]},columnStyles:{3:{halign:"right"}}}),this.yPos=this.doc.lastAutoTable.finalY+10,this}agregarFirma(){return this.yPos>250?(this.doc.addPage(),this.yPos=40):this.yPos+=30,this.doc.line(14,this.yPos,80,this.yPos),this.doc.text("Firma Cajero",14,this.yPos+5),this.doc.line(110,this.yPos,180,this.yPos),this.doc.text("Firma Supervisor",110,this.yPos+5),this}build(r="reporte_cierre.pdf"){this.doc.save(r)}}var t=c(8699),C=c(1757),b=c(9287);let v=(()=>{class s{constructor(e){this.http=e}obtenerUltimoCierre(){return this.http.GetRequest("/cierrecaja")}crearCierre(e){return this.http.PostRequest("/cierrecaja",e)}static{this.\u0275fac=function(a){return new(a||s)(t.KVO(b.a))}}static{this.\u0275prov=t.jDH({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();var y=c(1919);function j(s,r){if(1&s&&(t.j41(0,"p",40),t.EFF(1," \xdaltimo cierre realizado hasta factura: "),t.j41(2,"strong"),t.EFF(3),t.k0s()()),2&s){const e=t.XpG();t.R7$(3),t.JRh(e.ultimaFacturaCuadrada)}}function P(s,r){1&s&&(t.j41(0,"p",40),t.EFF(1," No se detect\xf3 cierre previo. Se cargar\xe1n todas las facturas disponibles. "),t.k0s())}function E(s,r){if(1&s&&(t.j41(0,"tr")(1,"td",41),t.EFF(2),t.k0s(),t.j41(3,"td"),t.EFF(4),t.nI1(5,"date"),t.k0s(),t.j41(6,"td"),t.EFF(7),t.k0s(),t.j41(8,"td",42),t.EFF(9),t.nI1(10,"number"),t.k0s(),t.j41(11,"td",36),t.EFF(12),t.k0s()()),2&s){const e=r.$implicit,a=t.XpG();t.R7$(2),t.JRh(e.fa_codFact),t.R7$(2),t.JRh(t.i5U(5,5,e.fa_fecFact,"dd/MM/yyyy HH:mm")),t.R7$(3),t.JRh(e.fa_nomClie),t.R7$(2),t.JRh(t.i5U(10,8,e.fa_valFact,"1.2-2")),t.R7$(3),t.JRh(a.obtenerDescripcionPago(e.fa_fpago))}}function x(s,r){1&s&&(t.j41(0,"tr")(1,"td",43),t.nrm(2,"i",44),t.j41(3,"p"),t.EFF(4,"No hay facturas pendientes para cerrar en este rango."),t.k0s()()())}function k(s,r){1&s&&(t.j41(0,"div",45)(1,"div",46)(2,"span",47),t.EFF(3,"Cargando..."),t.k0s()()())}const R=[{path:"",component:(()=>{class s{constructor(e,a,i){this.facturaService=e,this.cierreService=a,this.fpagoService=i,this.facturas=[],this.facturasFiltradas=[],this.ultimaFacturaCuadrada="",this.isLoading=!1,this.formasPago=[],this.inicioFactura="",this.finFactura="",this.totales={efectivo:0,tarjeta:0,credito:0,deposito:0,cheque:0,total:0}}ngOnInit(){console.log("CuadreCaja Component Initialized - Version Updated"),this.cargarFormasPago(),this.obtenerUltimoCierreYFacturas()}cargarFormasPago(){this.fpagoService.obtenerTodosFpago().subscribe({next:e=>{console.log("Formas de pago cargadas:",e.data),this.formasPago=e.data||[]},error:e=>{console.error("Error cargando formas de pago",e)}})}obtenerDescripcionPago(e){if(!e)return"";const a=String(e).trim(),i=this.formasPago.find(o=>String(o.fp_codfpago)===a||o.fp_descfpago.toLowerCase()===a.toLowerCase());return i?`${i.fp_codfpago} - ${i.fp_descfpago}`:e}obtenerUltimoCierreYFacturas(){this.isLoading=!0,this.cierreService.obtenerUltimoCierre().subscribe({next:e=>{const a=Array.isArray(e?.data)?e.data:[];this.ultimaFacturaCuadrada=a.length>0&&a[0].factfin||"",this.cargarFacturasPendientes()},error:e=>{console.error("Error obteniendo \xfaltimo cierre",e),this.cargarFacturasPendientes()}})}cargarFacturasPendientes(){this.facturaService.buscarTodasFacturacion().subscribe({next:e=>{this.isLoading=!1;const a=e.data||[];console.log("Facturas cargadas:",a.length>0?a[0]:"No hay facturas"),this.facturas=a,this.aplicarFiltros()},error:e=>{this.isLoading=!1,console.error(e),d().fire("Error","No se pudieron cargar las facturas","error")}})}aplicarFiltros(){if(!this.facturas.length)return;let e=this.facturas;if(this.ultimaFacturaCuadrada){const a=Number(this.ultimaFacturaCuadrada);e=this.facturas.filter(i=>{const o=Number(i.fa_codFact);return isNaN(a)||isNaN(o)?String(i.fa_codFact)>String(this.ultimaFacturaCuadrada):o>a})}if(e.length>0){const a=[...e].sort((i,o)=>String(i.fa_codFact).localeCompare(String(o.fa_codFact)));this.inicioFactura=a[0].fa_codFact,this.finFactura=a[a.length-1].fa_codFact,this.facturasFiltradas=a}else this.facturasFiltradas=[];this.calcularTotales()}calcularTotales(){this.totales={efectivo:0,tarjeta:0,credito:0,deposito:0,cheque:0,total:0},this.facturasFiltradas.forEach(e=>{const a=Number(e.fa_valFact)||0,i=this.obtenerDescripcionPago(e.fa_fpago).toLowerCase();i.includes("efectivo")||i.includes("contado")?this.totales.efectivo+=a:i.includes("tarjeta")||i.includes("t/c")?this.totales.tarjeta+=a:i.includes("credito")?this.totales.credito+=a:i.includes("deposito")||i.includes("transferencia")?this.totales.deposito+=a:i.includes("cheque")?this.totales.cheque+=a:this.totales.efectivo+=a}),this.totales.total=this.totales.efectivo+this.totales.tarjeta+this.totales.credito+this.totales.deposito+this.totales.cheque}generarReporte(){(new p).iniciarDocumento("Cierre de Caja").agregarDatosGenerales(`Desde Factura ${this.inicioFactura} hasta ${this.finFactura}`,`\xdaltima Cuadrada: ${this.ultimaFacturaCuadrada||"Ninguna"}`).agregarTotales(this.totales,this.formatoMoneda).agregarTablaDetalle(this.facturasFiltradas,this.formatoMoneda,a=>this.obtenerDescripcionPago(a)).agregarFirma().build("cierre_caja.pdf")}formatoMoneda(e){return new Intl.NumberFormat("es-DO",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e)}realizarCierre(){if(0===this.facturasFiltradas.length)return void d().fire("Atenci\xf3n","No hay facturas para cerrar en este periodo.","warning");const e=this.facturasFiltradas[this.facturasFiltradas.length-1].fa_codFact;d().fire({title:"\xbfConfirmar Cierre de Caja?",text:`Se cerrar\xe1 hasta la factura ${e}.`,icon:"warning",showCancelButton:!0,confirmButtonText:"S\xed, cerrar caja"}).then(a=>{if(a.isConfirmed){const i={feccierre:(new Date).toISOString(),factfin:e,montocierre:this.totales.total,efectivo:this.totales.efectivo,tarjeta:this.totales.tarjeta,cheque:this.totales.cheque,deposito:this.totales.deposito,nota:"Cierre generado desde frontend"};this.cierreService.crearCierre(i).subscribe({next:o=>{d().fire("Cerrado!","La caja ha sido cerrada correctamente.","success"),this.generarReporte(),this.obtenerUltimoCierreYFacturas()},error:o=>{console.error(o),d().fire("Error","No se pudo registrar el cierre en base de datos","error")}})}})}static{this.\u0275fac=function(a){return new(a||s)(t.rXU(C._),t.rXU(v),t.rXU(y.U))}}static{this.\u0275cmp=t.VBU({type:s,selectors:[["app-cuadrecaja"]],decls:98,vars:32,consts:[[1,"container-fluid","p-4"],[1,"row","mb-4"],[1,"col-md-6"],[1,"text-primary"],[1,"fas","fa-cash-register","me-2"],["class","text-muted",4,"ngIf"],[1,"col-md-6","d-flex","justify-content-end","align-items-center","gap-2"],[1,"input-group","input-group-sm",2,"width","auto"],[1,"input-group-text"],["type","text","readonly","",1,"form-control",3,"value"],[1,"btn","btn-sm","btn-outline-secondary",3,"click"],[1,"fas","fa-print","me-1"],[1,"btn","btn-sm","btn-success",3,"click"],[1,"fas","fa-check-circle","me-1"],[1,"sticky-top","bg-white","pb-3","pt-2",2,"z-index","1020","border-bottom","1px solid #e3e6f0"],[1,"row","row-cols-1","row-cols-md-3","row-cols-xl-6","g-2"],[1,"col"],[1,"card","bg-success","text-white","shadow-sm","h-100"],[1,"card-body","p-2","text-center"],[1,"card-title","text-uppercase","font-weight-bold","opacity-75","small","mb-1"],[1,"mb-0"],[1,"card","bg-info","text-white","shadow-sm","h-100"],[1,"card","bg-primary","text-white","shadow-sm","h-100"],[1,"card","bg-warning","text-dark","shadow-sm","h-100"],[1,"card","bg-secondary","text-white","shadow-sm","h-100"],[1,"card","bg-dark","text-white","shadow-sm","h-100"],[1,"card","shadow","mb-4"],[1,"card-header","py-3","bg-white","d-flex","justify-content-between","align-items-center"],[1,"m-0","font-weight-bold","text-primary"],[1,"badge","bg-secondary"],[1,"card-body","p-0"],[1,"table-responsive"],[1,"table","table-hover","table-striped","align-middle","mb-0"],[1,"bg-light"],[1,"ps-4"],[1,"text-end"],[1,"text-end","pe-4"],[4,"ngFor","ngForOf"],[4,"ngIf"],["class","position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75","style","z-index: 1050;",4,"ngIf"],[1,"text-muted"],[1,"ps-4","fw-bold"],[1,"fw-bold","text-end"],["colspan","5",1,"text-center","py-5","text-muted"],[1,"fas","fa-inbox","fa-3x","mb-3"],[1,"position-fixed","top-0","start-0","w-100","h-100","d-flex","justify-content-center","align-items-center","bg-white","bg-opacity-75",2,"z-index","1050"],["role","status",1,"spinner-border","text-primary"],[1,"visually-hidden"]],template:function(a,i){1&a&&(t.j41(0,"div",0)(1,"div",1)(2,"div",2)(3,"h2",3),t.nrm(4,"i",4),t.EFF(5,"Cierre de Caja"),t.k0s(),t.DNE(6,j,4,1,"p",5),t.DNE(7,P,2,0,"p",5),t.k0s(),t.j41(8,"div",6)(9,"div",7)(10,"span",8),t.EFF(11,"Desde Factura"),t.k0s(),t.nrm(12,"input",9),t.k0s(),t.j41(13,"div",7)(14,"span",8),t.EFF(15,"Hasta Factura"),t.k0s(),t.nrm(16,"input",9),t.k0s(),t.j41(17,"button",10),t.bIt("click",function(){return i.generarReporte()}),t.nrm(18,"i",11),t.EFF(19," PDF "),t.k0s(),t.j41(20,"button",12),t.bIt("click",function(){return i.realizarCierre()}),t.nrm(21,"i",13),t.EFF(22," Confirmar Cierre "),t.k0s()()(),t.j41(23,"div",14)(24,"div",15)(25,"div",16)(26,"div",17)(27,"div",18)(28,"h6",19),t.EFF(29,"Efectivo"),t.k0s(),t.j41(30,"h5",20),t.EFF(31),t.nI1(32,"number"),t.k0s()()()(),t.j41(33,"div",16)(34,"div",21)(35,"div",18)(36,"h6",19),t.EFF(37,"Tarjeta"),t.k0s(),t.j41(38,"h5",20),t.EFF(39),t.nI1(40,"number"),t.k0s()()()(),t.j41(41,"div",16)(42,"div",22)(43,"div",18)(44,"h6",19),t.EFF(45,"Cr\xe9dito"),t.k0s(),t.j41(46,"h5",20),t.EFF(47),t.nI1(48,"number"),t.k0s()()()(),t.j41(49,"div",16)(50,"div",23)(51,"div",18)(52,"h6",19),t.EFF(53,"Dep\xf3sito"),t.k0s(),t.j41(54,"h5",20),t.EFF(55),t.nI1(56,"number"),t.k0s()()()(),t.j41(57,"div",16)(58,"div",24)(59,"div",18)(60,"h6",19),t.EFF(61,"Cheque"),t.k0s(),t.j41(62,"h5",20),t.EFF(63),t.nI1(64,"number"),t.k0s()()()(),t.j41(65,"div",16)(66,"div",25)(67,"div",18)(68,"h6",19),t.EFF(69,"Total General"),t.k0s(),t.j41(70,"h5",20),t.EFF(71),t.nI1(72,"number"),t.k0s()()()()()(),t.j41(73,"div",26)(74,"div",27)(75,"h6",28),t.EFF(76,"Detalle de Movimientos Pendientes de Cierre"),t.k0s(),t.j41(77,"span",29),t.EFF(78),t.k0s()(),t.j41(79,"div",30)(80,"div",31)(81,"table",32)(82,"thead",33)(83,"tr")(84,"th",34),t.EFF(85,"C\xf3digo Factura"),t.k0s(),t.j41(86,"th"),t.EFF(87,"Fecha"),t.k0s(),t.j41(88,"th"),t.EFF(89,"Nombre Cliente"),t.k0s(),t.j41(90,"th",35),t.EFF(91,"Valor Factura"),t.k0s(),t.j41(92,"th",36),t.EFF(93,"Forma Pago"),t.k0s()()(),t.j41(94,"tbody"),t.DNE(95,E,13,11,"tr",37),t.DNE(96,x,5,0,"tr",38),t.k0s()()()()(),t.DNE(97,k,4,0,"div",39),t.k0s()),2&a&&(t.R7$(6),t.Y8G("ngIf",i.ultimaFacturaCuadrada),t.R7$(1),t.Y8G("ngIf",!i.ultimaFacturaCuadrada),t.R7$(5),t.Y8G("value",i.inicioFactura),t.R7$(4),t.Y8G("value",i.finFactura),t.R7$(15),t.JRh(t.i5U(32,14,i.totales.efectivo,"1.2-2")),t.R7$(8),t.JRh(t.i5U(40,17,i.totales.tarjeta,"1.2-2")),t.R7$(8),t.JRh(t.i5U(48,20,i.totales.credito,"1.2-2")),t.R7$(8),t.JRh(t.i5U(56,23,i.totales.deposito,"1.2-2")),t.R7$(8),t.JRh(t.i5U(64,26,i.totales.cheque,"1.2-2")),t.R7$(8),t.JRh(t.i5U(72,29,i.totales.total,"1.2-2")),t.R7$(7),t.SpI("",i.facturasFiltradas.length," Facturas"),t.R7$(17),t.Y8G("ngForOf",i.facturasFiltradas),t.R7$(1),t.Y8G("ngIf",0===i.facturasFiltradas.length),t.R7$(1),t.Y8G("ngIf",i.isLoading))},dependencies:[n.Sq,n.bT,n.QX,n.vh],styles:[".card-header[_ngcontent-%COMP%]{font-weight:700}.table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:#f8f9fa}.text-end[_ngcontent-%COMP%]{text-align:right}"]})}}return s})()}];let w=(()=>{class s{static{this.\u0275fac=function(a){return new(a||s)}}static{this.\u0275mod=t.$C({type:s})}static{this.\u0275inj=t.G2t({imports:[l.iI.forChild(R),l.iI]})}}return s})(),$=(()=>{class s{static{this.\u0275fac=function(a){return new(a||s)}}static{this.\u0275mod=t.$C({type:s})}static{this.\u0275inj=t.G2t({imports:[n.MD,u.YN,w]})}}return s})()}}]);