<style>
  /* Layout Containers */
  .cobro-layout-container {
    height: calc(100vh - 7rem); /* Adjust based on global header height */
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .content-row {
    flex: 1;
    min-height: 0; /* Crucial for nested flex scrolling */
  }

  .col-panel {
    height: 100%;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* Specific Components */
  .card-flex {
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Contains children */
  }

  .card-body-flex {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    padding: 0;
  }

  /* Invoice List Specifics */
  .invoice-list-card {
    flex: 1; /* Takes remaining space */
    min-height: 200px;
  }

  .payment-panel-card {
    flex: 0 0 auto; /* Natural height based on content */
  }

  /* Invoice Detail Specifics */
  .invoice-detail-card {
    height: 100%;
  }

  .items-table-container {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
  }

  /* Visual Styles */
  .sticky-header thead th {
    position: sticky;
    top: 0;
    z-index: 5;
    background-color: #212529;
    color: #fff;
  }
  .table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.06);
  }
  .card-header-brand {
    background: linear-gradient(135deg, #ec0404, #0d6efd);
    color: #fff;
  }
  .cursor-pointer { cursor: pointer; }

  .invoice-detail-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    color: #6c757d;
    font-weight: 600;
  }
  .invoice-detail-value {
    font-weight: 500;
    color: #212529;
    font-size: 0.9rem;
  }

  .total-row {
    display: flex; justify-content: space-between; align-items: center; padding: 2px 0;
  }
  .total-row.final {
    border-top: 1px solid #dee2e6; margin-top: 4px; padding-top: 4px; font-size: 1.1rem;
  }
</style>

<div class="container-fluid px-3 py-2 cobro-layout-container">

  <div class="row g-3 content-row">
    <!-- Left Column: List (Flexible) & Payment (Fixed) -->
    <div class="col-lg-7 col-panel">

      <!-- Invoice List Card (Flexible Height) -->
      <div class="card shadow-sm border-0 card-flex invoice-list-card">
        <div class="card-header card-header-brand py-2 d-flex align-items-center flex-shrink-0">
          <i class="bi bi-list-ul me-2"></i>
          <h6 class="card-title m-0">Facturas Pendientes</h6>
        </div>

        <div class="card-body-flex">
          <table class="table table-hover table-sm sticky-header mb-0">
            <thead class="table-dark">
              <tr>
                <th class="ps-3 col-2">Número</th>
                <th class="col-5">Cliente / Fecha</th>
                <th class="col-3 text-end">Valor</th>
                <th class="col-2 text-center pe-3">Acción</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let factura of facturacionList; let i = index"
                [ngClass]="{'table-primary': factura.fa_codFact === codFacturaselecte}"
                class="align-middle cursor-pointer"
                (click)="consultarFacturacion(factura)"
              >
                <td class="ps-3">
                  <div class="fw-bold text-primary small">{{ factura.fa_codFact }}</div>
                </td>
                <td>
                  <div class="d-flex flex-column">
                    <span class="fw-semibold text-truncate small" style="max-width: 200px;">
                      {{ factura.fa_nomClie || 'Sin nombre' }}
                    </span>
                    <div class="d-flex align-items-center gap-3 mt-1">
                      <small class="text-muted" style="font-size: 0.75rem;">{{ factura.fa_fecFact }}</small>

                      <div class="d-flex align-items-center gap-2">
                        <!-- Status Badge -->
                        <span *ngIf="factura.fa_impresa === 'P'" class="badge bg-danger text-white rounded-pill d-flex align-items-center px-2 py-1" style="font-size: 0.65em" title="Estado: Pendiente">
                            <i class="bi bi-exclamation-circle me-1"></i> Pendiente
                        </span>

                        <!-- Delivery Mode -->
                        <div [ngSwitch]="getDeliveryMode(factura.fa_envio)" title="Modo de Entrega">
                            <!-- Envio -->
                            <span *ngSwitchCase="'Envio'" class="badge bg-light text-info border border-info rounded-pill d-flex align-items-center px-2 py-1" style="font-size: 0.65em">
                                <i class="bi bi-truck me-1"></i> Envio
                            </span>

                            <!-- Retiro -->
                            <span *ngSwitchCase="'Retiro'" class="badge bg-light text-warning border border-warning rounded-pill d-flex align-items-center px-2 py-1" style="font-size: 0.65em">
                                <i class="bi bi-shop me-1"></i> Retiro
                            </span>

                            <!-- Default -->
                            <span *ngSwitchDefault class="badge rounded-pill bg-secondary text-white" style="font-size: 0.65em">{{ factura.fa_envio }}</span>
                        </div>

                        <!-- Payment Method -->
                        <div [ngSwitch]="factura.fa_codfpago" title="Forma de Pago">
                            <span *ngSwitchCase="1" class="badge bg-light text-success border border-success rounded-pill d-flex align-items-center px-2 py-1" style="font-size: 0.65em">
                                <i class="bi bi-cash-stack me-1"></i> Efectivo
                            </span>
                            <span *ngSwitchCase="2" class="badge bg-light text-danger border border-danger rounded-pill d-flex align-items-center px-2 py-1" style="font-size: 0.65em">
                                <i class="bi bi-clock-history me-1"></i> Crédito
                            </span>
                            <span *ngSwitchCase="3" class="badge bg-light text-primary border border-primary rounded-pill d-flex align-items-center px-2 py-1" style="font-size: 0.65em">
                                <i class="bi bi-bank me-1"></i> Cheque
                            </span>
                            <span *ngSwitchCase="4" class="badge bg-light text-info border border-info rounded-pill d-flex align-items-center px-2 py-1" style="font-size: 0.65em">
                                <i class="bi bi-arrow-left-right me-1"></i> Transf./Dep.
                            </span>
                            <span *ngSwitchCase="5" class="badge bg-light text-warning border border-warning rounded-pill d-flex align-items-center px-2 py-1" style="font-size: 0.65em">
                                <i class="bi bi-credit-card-2-front me-1"></i> Tarjeta
                            </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
                <td class="text-end">
                  <div class="fw-bold text-success small">${{ factura.fa_valFact | number: '1.2-2' }}</div>
                </td>
                <td class="text-center pe-3">
                  <button class="btn btn-sm btn-outline-primary py-0 px-1" title="Seleccionar">
                    <i class="bi bi-chevron-right small"></i>
                  </button>
                </td>
              </tr>
              <tr *ngIf="facturacionList.length === 0">
                <td colspan="4" class="text-center py-5 text-muted">
                  <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                  No hay facturas pendientes
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Payment Panel (Fixed Height at Bottom) -->
      <div class="card shadow-sm border-0 payment-panel-card flex-shrink-0">
        <div class="card-header bg-success text-white py-2 d-flex justify-content-between align-items-center">
          <h6 class="card-title m-0"><i class="bi bi-cash-coin me-2"></i>Gestión de Pago</h6>
          <span class="badge bg-white text-success shadow-sm">#{{ formularioFacturacion.get('fa_codFact')?.value || '---' }}</span>
        </div>
        <div class="card-body bg-light py-2">
          <div class="row g-2">
            <!-- Settings -->
            <div class="col-md-5 border-end">
              <div class="d-flex align-items-center mb-2">
                <div class="form-check form-switch m-0">
                  <input [disabled]="chekpagada" type="checkbox" id="chk1" class="form-check-input"
                    [checked]="chekPagado" (click)="toggleCheckPagado()" style="cursor: pointer;">
                  <label for="chk1" class="form-check-label fw-bold ms-2 small" style="cursor: pointer;">MARCAR PAGADA</label>
                </div>
              </div>

              <div class="mb-2">
                <div class="input-group input-group-sm">
                  <span class="input-group-text bg-white"><i class="bi bi-credit-card"></i></span>
                  <select name="formapago" [(ngModel)]="ftipoPago" class="form-select" [disabled]="!chekPagado">
                    <option [value]="fpago.fp_codfpago" *ngFor="let fpago of resultadoFpago">{{fpago.fp_descfpago}}</option>
                  </select>
                </div>
              </div>

              <div class="mb-0">
                <div class="input-group input-group-sm">
                  <span class="input-group-text bg-white"><i class="bi bi-box-seam"></i></span>
                  <select class="form-select" [(ngModel)]="fentrega" [disabled]="!chekPagado">
                    <option [value]="fe.idfentrega" *ngFor="let fe of resultadoFentrega">{{ fe.desentrega }}</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Calculator -->
            <div class="col-md-7">
              <div class="row g-2">
                <div class="col-6">
                    <label class="form-label text-muted small fw-bold mb-0" style="font-size: 0.7rem;">TOTAL</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white text-success fw-bold border-end-0">$</span>
                        <input type="text" class="form-control bg-white fw-bold text-success text-end border-start-0"
                        [value]="formularioFacturacion.get('fa_valFact')?.value | number:'1.2-2'" readonly />
                    </div>
                </div>
                <div class="col-6">
                    <label class="form-label text-muted small fw-bold mb-0" style="font-size: 0.7rem;">RECIBIDO</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white fw-bold border-end-0">$</span>
                        <input #valorPagadoInput type="number" class="form-control fw-bold text-end border-start-0"
                        [ngClass]="{ 'is-invalid': valorPagado < (formularioFacturacion.get('fa_valFact')?.value || 0) && valorPagado > 0 }"
                        [value]="valorPagado" [disabled]="txtvalPagado" (input)="onValorPagadoChange($event)" placeholder="0.00" />
                    </div>
                </div>
                <div class="col-12">
                     <div class="d-flex justify-content-between align-items-center bg-white px-2 py-1 rounded border">
                        <span class="small fw-bold text-muted">CAMBIO:</span>
                        <span class="fw-bold text-primary">${{ valCambio | number:'1.2-2' }}</span>
                     </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Buttons -->
          <div class="d-flex gap-2 mt-2">
            <button class="btn btn-sm btn-outline-secondary flex-fill" (click)="limpia()">
              <i class="bi bi-x-circle me-1"></i>Cancelar
            </button>
            <button class="btn btn-sm btn-primary flex-fill fw-bold"
              [disabled]="!chekPagado || valorPagado < (formularioFacturacion.get('fa_valFact')?.value || 0)"
              (click)="marcarImpresa()">
              <i class="bi bi-check-lg me-1"></i>Cobrar
            </button>
            <button class="btn btn-sm btn-dark flex-fill" [disabled]="!chekPagado && fentrega != 1 && fentrega != '1' && fentrega != 'Envio'" (click)="buscarFactura()">
              <i class="bi bi-printer me-1"></i>Imprimir
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Invoice Details (Full Height) -->
    <div class="col-lg-5 col-panel">
      <div class="card shadow border-0 card-flex invoice-detail-card">
        <div class="card-header bg-white border-bottom py-2 flex-shrink-0">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="card-title m-0 text-dark fw-bold">
              <i class="bi bi-file-earmark-text text-danger me-2"></i>Vista Previa
            </h6>
            <div class="text-end">
              <span class="badge bg-light text-dark border">{{ formularioFacturacion.get('fa_codFact')?.value || '---' }}</span>
            </div>
          </div>
        </div>

        <!-- Scrollable Content Wrapper -->
        <div class="d-flex flex-column flex-grow-1 overflow-hidden">

            <!-- Client Info (Fixed within scroll or scrollable? Better fixed at top of detail) -->
            <div class="p-3 bg-white border-bottom flex-shrink-0">
                <form [formGroup]="formularioFacturacion">
                    <div class="row g-2">
                        <div class="col-12">
                            <label class="invoice-detail-label">Cliente</label>
                            <div class="invoice-detail-value text-truncate">
                                {{ formularioFacturacion.get('fa_nomClie')?.value || '---' }}
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="invoice-detail-label">RNC</label>
                            <div class="invoice-detail-value small">
                                {{ formularioFacturacion.get('fa_rncFact')?.value || '---' }}
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="invoice-detail-label">Teléfono</label>
                            <div class="invoice-detail-value small">
                                {{ formularioFacturacion.get('fa_telClie')?.value || '---' }}
                            </div>
                        </div>
                         <div class="col-12">
                            <label class="invoice-detail-label">Dirección</label>
                            <div class="invoice-detail-value text-truncate small">
                                {{ formularioFacturacion.get('fa_dirClie')?.value || '---' }}
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="invoice-detail-label">NCF</label>
                            <div class="invoice-detail-value small">
                                {{ formularioFacturacion.get('fa_ncfFact')?.value || '---' }}
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Items Table (Flexible Scroll) -->
            <div class="items-table-container bg-light">
                <table class="table table-sm table-striped mb-0 small">
                    <thead class="table-light text-secondary sticky-header">
                        <tr>
                            <th class="ps-3" style="width: 50%">Descripción</th>
                            <th class="text-center" style="width: 15%">Cant.</th>
                            <th class="text-end pe-3" style="width: 35%">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of items">
                            <td class="ps-3">
                                <div class="fw-bold text-truncate" style="max-width: 150px;">{{ item.producto?.in_desmerc }}</div>
                            </td>
                            <td class="text-center">{{ item.cantidad }}</td>
                            <td class="text-end pe-3 fw-bold">${{ item.total | number: '1.2-2' }}</td>
                        </tr>
                        <tr *ngIf="items.length === 0">
                            <td colspan="3" class="text-center py-4 text-muted">
                                <small>Sin items</small>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Totals (Fixed Bottom) -->
            <div class="p-3 bg-white border-top flex-shrink-0">
                <div class="total-row">
                    <span class="text-muted small">Subtotal</span>
                    <span class="fw-bold small">${{ subTotal | number:'1.2-2' }}</span>
                </div>
                <div class="total-row">
                    <span class="text-muted small">Descuento</span>
                    <span class="fw-bold text-danger small">-${{ descuentotxt || '0.00' }}</span>
                </div>
                <div class="total-row">
                    <span class="text-muted small">ITBIS (18%)</span>
                    <span class="fw-bold small">${{ totalItbis | number:'1.2-2' }}</span>
                </div>
                <div class="total-row final text-success">
                    <span class="fw-bold">TOTAL</span>
                    <span class="fw-bolder fs-5">${{ totalGral | number:'1.2-2' }}</span>
                </div>
            </div>

        </div>
      </div>
    </div>

  </div>
</div>
