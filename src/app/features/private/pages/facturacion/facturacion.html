<div class="container-fluid p-3 full-height-container">
  <div class="row g-3 main-row">
    <!-- Columna Izquierda: Datos de Factura -->
    <div class="col-xl-4 col-left">
      <div class="card shadow-sm border-0">
        <div class="card-header text-white d-flex justify-content-between align-items-center" style="background: linear-gradient(90deg, #0d6efd, #20c997); box-shadow: 0 2px 8px rgba(13,110,253,.2)">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-receipt me-2"></i>Datos de Factura
          </h5>
          <div class="d-flex align-items-center gap-3 small">
            <div class="d-flex align-items-center" *ngIf="formularioFacturacion.get('fa_codFact')?.value">
              <span class="opacity-75 me-1">No.</span>
              <span class="fw-bold bg-white bg-opacity-25 px-2 py-1 rounded">{{formularioFacturacion.get('fa_codFact')?.value}}</span>
            </div>
            <div class="d-flex align-items-center" *ngIf="formularioFacturacion.get('fa_fecFact')?.value">
              <i class="bi bi-calendar-event opacity-75 me-1"></i>
              <span class="fw-bold">{{formularioFacturacion.get('fa_fecFact')?.value}}</span>
            </div>
          </div>
        </div>
        <div class="card-body bg-light">
          <form
            [formGroup]="formularioFacturacion"
            (ngSubmit)="guardarFacturacion()"
          >
            <!-- RNC y Tipo NCF -->

            <div class="row g-2 mb-2">
              <div class="col-md-4">
                <label class="form-label small text-muted fw-semibold"
                  >RNC</label
                >
                <input
                  type="text"
                  #input1
                  id="input1"
                  (keydown.enter)="buscarRnc($event,input2)"
                  (keydown.tab)="buscarRnc($event,input2)"
                  formControlName="fa_rncFact"
                  class="form-control"
                />
              </div>
              <div class="col-md-5">
                <label class="form-label small text-muted fw-semibold"
                  >Tipo NCF</label
                >
                <select
                  name="tipoNcf"
                  formControlName="fa_tipoNcf"
                  (keydown.enter)="moveFocus($event, input3)"
                  class="form-select"
                >
                  <option [value]="ncf.codigo" *ngFor="let ncf of ncflist">
                    {{ncf.tipo}} - {{ncf.desNcf}}
                  </option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted fw-semibold"
                  >NCF</label
                >
                <input
                  type="text"
                  class="form-control"
                  formControlName="fa_ncfFact"
                  placeholder="NCF"
                />
              </div>
            </div>

            <!-- Cliente -->
            <div class="mb-2">
              <label class="form-label small text-muted fw-semibold"
                >Cliente</label
              >
              <div class="position-relative">
                <input
                  class="form-control text-uppercase"
                  type="text"
                  autocomplete="off"
                  (keydown.enter)="moveFocusnomclie($event, input3)"
                  (keydown)="handleKeydown($event)"
                  #input2
                  id="input2"
                  formControlName="fa_nomClie"
                />
                <div
                  [style.display]="resultadoNombre.length > 0 ? 'block' : 'none'"
                  class="dropdown-menu shadow-sm w-100"
                  style="
                    margin-top: 2px;
                    z-index: 2000;
                    max-height: 250px;
                    overflow-y: auto;
                    border-radius: 12px;
                    border: none;
                  "
                >
                  <a
                    *ngFor="let result of resultadoNombre; let i = index"
                    (click)="cargarDatosCliente(result)"
                    [class.active]="i === selectedIndex"
                    class="dropdown-item d-flex align-items-center py-2"
                    style="cursor: pointer"
                  >
                    <i class="bi bi-person-circle me-2 text-primary"></i>
                    <span>{{ result.cl_nomClie }}</span>
                  </a>
                </div>
              </div>
            </div>

            <!-- Dirección -->
            <div class="mb-2">
              <label class="form-label small text-muted fw-semibold"
                >Dirección</label
              >
              <input
                type="text"
                id="input3"
                formControlName="fa_dirClie"
                (keydown.enter)="moveFocus($event, input4)"
                #input3
                class="form-control text-uppercase"
              />
            </div>

            <!-- Teléfono y Sector -->
            <div class="row g-2 mb-2">
              <div class="col-md-6">
                <label class="form-label small text-muted fw-semibold">Teléfono</label>
                <input
                  type="text"
                  id="input4"
                  formControlName="fa_telClie"
                  (keydown.enter)="moveFocus($event, input6)"
                  #input4
                  placeholder="Teléfono"
                  class="form-control"
                />
              </div>
              <div class="col-md-6">
                <label class="form-label small text-muted fw-semibold"
                  >Sector</label
                >
                <div class="position-relative">
                  <input
                    type="text"
                    formControlName="fa_sector"
                    (keydown.enter)="moveFocus($event, input7)"
                    (keydown)="handleKeydownSector($event)"
                    #input6
                    placeholder="Sector"
                    class="form-control text-uppercase"
                    [formControl]="buscarSector"
                  />
                  <div
                    [style.display]="resultadoSector.length > 0 ? 'block' : 'none'"
                    class="dropdown-menu shadow-sm w-100"
                    style="
                      margin-top: 2px;
                      z-index: 2000;
                      max-height: 200px;
                      overflow-y: auto;
                      border-radius: 12px;
                      border: none;
                    "
                  >
                    <a
                      *ngFor="let result of resultadoSector; let i = index"
                      (click)="cargarDatosSector(result)"
                      [class.active]="i === selectedIndexsector"
                      class="dropdown-item d-flex align-items-center py-2"
                      style="cursor: pointer"
                    >
                      <i class="bi bi-geo-alt me-2 text-success"></i>
                      <span>{{ result.se_desSect }}</span>
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Correo y Contacto -->
            <div class="row g-2 mb-2">
              <div class="col-md-7">
                <label class="form-label small text-muted fw-semibold"
                  >Correo</label
                >
                <input
                  type="email"
                  formControlName="fa_correo"
                  (keydown.enter)="moveFocus($event, input8)"
                  #input7
                  class="form-control"
                  [attr.disabled]="isDisabled ? true : null"
                />
              </div>
              <div class="col-md-5">
                <label class="form-label small text-muted fw-semibold"
                  >Contacto</label
                >
                <input
                  type="text"
                  formControlName="fa_contacto"
                  placeholder="Contacto"
                  (keydown.enter)="moveFocus($event, input9)"
                  #input8
                  class="form-control text-uppercase"
                />
              </div>
            </div>

            <!-- Tipo Pago, Envío y Vendedor -->
            <div class="row g-2 mb-2">
              <div class="col-md-4 position-relative">
                <label class="form-label small text-muted fw-semibold"
                  >Tipo Pago</label
                >
                <input
                  type="text"
                  #input9
                  id="input9"
                  [formControl]="buscarFpago"
                  (keydown)="handleKeydownFpago($event)"
                  (focus)="resultadoFpago = listaFpago"
                  class="form-control"
                  placeholder="Seleccionar Pago"
                  autocomplete="off"
                />
                <div
                  class="dropdown-menu show w-100"
                  [style.display]="resultadoFpago.length > 0 ? 'block' : 'none'"
                  style="max-height: 200px; overflow-y: auto; position: absolute; z-index: 1000;"
                >
                  <a
                    class="dropdown-item"
                    *ngFor="let fpago of resultadoFpago; let i = index"
                    [class.active]="i === selectedIndexfpago"
                    (click)="cargarDatosFpago(fpago)"
                    href="javascript:void(0)"
                  >
                    {{fpago.fp_descfpago}}
                  </a>
                </div>
              </div>
              <div class="col-md-4 position-relative">
                <label class="form-label small text-muted fw-semibold"
                  >Entrega</label
                >
                <input
                  type="text"
                  #input11
                  id="input11"
                  [formControl]="buscarEnvio"
                  (keydown)="handleKeydownEnvio($event)"
                  (focus)="resultadoEnvio = listaEnvio"
                  class="form-control"
                  placeholder="Seleccionar Entrega"
                  autocomplete="off"
                />
                <div
                  class="dropdown-menu show w-100"
                  [style.display]="resultadoEnvio.length > 0 ? 'block' : 'none'"
                  style="max-height: 200px; overflow-y: auto; position: absolute; z-index: 1000;"
                >
                  <a
                    class="dropdown-item"
                    *ngFor="let envio of resultadoEnvio; let i = index"
                    [class.active]="i === selectedIndexEnvio"
                    (click)="cargarDatosEnvio(envio)"
                    href="javascript:void(0)"
                  >
                    {{envio.descripcion}}
                  </a>
                </div>
              </div>
              <div class="col-md-2">
                <label class="form-label small text-muted fw-semibold"
                  >Vend.</label
                >
                <input
                  type="password"
                  (keydown.enter)="buscarUsuario($event, input13)"
                  formControlName="fa_codVend"
                  #input12
                  id="input12"
                  placeholder="Cod."
                  class="form-control text-uppercase"
                />
              </div>
              <div class="col-md-2">
                <label class="form-label small text-muted fw-semibold"
                  >&nbsp;</label
                >
                <input
                  type="text"
                  formControlName="fa_nomVend"
                  class="form-control"
                  readonly
                />
              </div>
            </div>
          </form>

          <!-- Botón para buscar facturas -->
          <div class="mt-3">
            <button
              class="btn btn-outline-primary w-100"
              data-bs-toggle="modal"
              data-bs-target="#modalBuscarFactura"
            >
              <i class="bi bi-search me-2"></i>Buscar Factura Existente
            </button>
          </div>

          <!-- Botones de Acción -->
          <div class="d-flex justify-content-between gap-2 mt-3">
            <button
              class="btn btn-outline-secondary flex-fill"
              (click)="limpia()"
            >
              <i class="bi bi-arrow-counterclockwise me-1"></i>Deshacer
            </button>
            <button
              class="btn btn-success flex-fill"
              (click)="guardarFacturacion()"
              [disabled]="isLoading"
            >
              <ng-container *ngIf="!isLoading">
                <i class="bi bi-check-circle me-1"></i>Guardar
              </ng-container>
              <ng-container *ngIf="isLoading">
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                Guardando...
              </ng-container>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Columna Derecha: Detalles de Factura -->
    <div class="col-xl-8 col-right">
      <div class="card shadow-sm border-0">
        <div class="card-header text-white" style="background: linear-gradient(90deg, #20c997, #0d6efd); box-shadow: 0 2px 8px rgba(32,201,151,.25)">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-list-ul me-2"></i>Detalles de la Factura
          </h5>
        </div>
        <div class="card-body">
          <!-- Agregar Productos (Restaurado a una fila) -->
          <div class="card border-0 shadow-sm mb-3 bg-light">
            <div class="card-body p-3">
              <h6 class="card-title text-primary fw-bold mb-3 small text-uppercase">
                <i class="bi bi-cart-plus me-2"></i>Agregar Producto
              </h6>

              <div class="row g-2 align-items-end">
                <!-- Código -->
                <div class="col-md-2">
                  <label class="form-label small text-muted fw-semibold">Código</label>
                  <div class="position-relative">
                    <input
                      class="form-control text-uppercase fw-bold"
                      type="text"
                      #codigoInput
                      autocomplete="off"
                      (keydown)="handleKeydownInventario($event)"
                      (keydown.enter)="moveFocuscodmerc($event, input14, input15)"
                      #input13
                      [formControl]="buscarcodmerc"
                      placeholder="Código"
                    />
                    <div
                      [style.display]="resultadoCodmerc.length > 0 ? 'block' : 'none'"
                      class="dropdown-menu shadow-sm"
                      style="
                        margin-top: 2px;
                        z-index: 2000;
                        max-height: 300px;
                        overflow-y: auto;
                        border-radius: 12px;
                        border: none;
                        min-width: 450px;
                      "
                    >
                      <a
                        *ngFor="let result of resultadoCodmerc; let i = index"
                        (click)="cargarDatosInventario(result)"
                        [class.active]="i === selectedIndexcodmerc"
                        class="dropdown-item d-flex align-items-center py-2"
                        style="cursor: pointer"
                      >
                        <i class="bi bi-box-seam me-2 text-success"></i>
                        <span>{{ result.in_codmerc || $any(result).IN_CODMERC }} - {{ result.in_desmerc || $any(result).IN_DESMERC }}</span>
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Descripción -->
                <div class="col-md-4">
                  <label class="form-label small text-muted fw-semibold">Descripción</label>
                  <div class="position-relative">
                    <input
                      class="form-control text-uppercase"
                      type="text"
                      #descripcionInput
                      autocomplete="off"
                      (keydown)="moveFocusdesc($event, input15)"
                      (keydown)="handleKeydownInventariosdesc($event)"
                      #input14
                      [formControl]="buscardescripcionmerc"
                      placeholder="Descripción del producto"
                    />
                    <div
                      [style.display]="resultadodescripcionmerc.length > 0 ? 'block' : 'none'"
                      class="dropdown-menu shadow-sm"
                      style="
                        margin-top: 2px;
                        z-index: 2000;
                        max-height: 300px;
                        overflow-y: auto;
                        border-radius: 12px;
                        border: none;
                        min-width: 450px;
                      "
                    >
                      <a
                        *ngFor="let result of resultadodescripcionmerc; let i = index"
                        (click)="cargarDatosInventario(result)"
                        [class.active]="i === selectedIndexdescripcionmerc"
                        class="dropdown-item d-flex align-items-center py-2"
                        style="cursor: pointer"
                      >
                        <i class="bi bi-box-seam me-2 text-success"></i>
                        <span>{{ result.in_codmerc || $any(result).IN_CODMERC }} - {{ result.in_desmerc || $any(result).IN_DESMERC }}</span>
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Cantidad -->
                <div class="col-md-2">
                  <label class="form-label small text-muted fw-semibold">Cantidad</label>
                  <input
                    type="number"
                    placeholder="0"
                    [formControl]="cantidadform"
                    #input15
                    id="input15"
                    (keydown)="moveFocusCantidad($event, input16)"
                    class="form-control fw-bold text-center"
                    min="1"
                  />
                </div>

                <!-- Precio -->
                <div class="col-md-2">
                  <label class="form-label small text-muted fw-semibold">Precio</label>
                  <input
                    type="number"
                    [formControl]="precioform"
                    #input16
                    (input)="actualizarCalculo()"
                    (keydown.enter)="moveFocusPrecio($event, input13)"
                    class="form-control fw-bold text-end"
                    min="0"
                    step="0.01"
                  />
                </div>

                <!-- Botón Agregar -->
                <div class="col-md-2">
                  <button
                    type="button"
                    class="btn btn-success w-100 fw-semibold"
                    (click)="agregaItem($event)"
                    title="Agregar producto a la lista"
                  >
                    <i class="bi bi-plus-lg me-2"></i>Agregar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Tabla de Productos -->
          <div
            class="table-responsive detalle-table-container mb-0">
            <table
              class="table table-hover table-sm align-middle mb-0"
              tabindex="0"
              (keydown)="navigateTable($event)"
              #Tabledetalle>
              <thead class="sticky-top" style="background: linear-gradient(90deg, #0d6efd, #20c997); color: #fff;">
                <tr>
                  <th style="width: 13%">Código</th>
                  <th style="width: 37%">Descripción</th>
                  <th class="text-center" style="width: 10%">Cant.</th>
                  <th class="text-end" style="width: 13%">Precio</th>
                  <th class="text-end" style="width: 15%">Total</th>
                  <th class="text-center" style="width: 12%">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let item of items; let i = index"
                  [class.table-active]="i === selectedRow"
                  (click)="selectRow(i)"
                  class="border-bottom"
                >
                  <td class="fw-semibold text-primary">
                    {{ item.producto?.in_codmerc }}
                  </td>
                  <td>{{ item.producto?.in_desmerc }}</td>
                  <td class="text-center">{{ item.cantidad }}</td>
                  <td class="text-end">{{ item.precio | currency }}</td>
                  <td class="text-end fw-semibold">
                    {{ item.total | currency }}
                  </td>
                  <td class="text-center">
                    <div
                      class="d-flex flex-wrap justify-content-center gap-1"
                      *ngIf="habilitarIcono"
                    >
                      <button
                        type="button"
                        class="btn btn-outline-primary btn-sm"
                        (click)="editarItem(item)"
                        title="Editar"
                      >
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-danger btn-sm"
                        (click)="borarItem(item)"
                        title="Eliminar"
                      >
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="items.length === 0">
                  <td colspan="6" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    No hay productos agregados
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Información de Producto y Totales (Rediseñado) -->
          <div class="row g-3 mt-2">
            <!-- Columna Izquierda: Información del Producto y Márgenes -->
            <div class="col-lg-8">
              <div class="card border-0 shadow-sm h-100" style="border-radius: 12px; background-color: #f8f9fa;">
                <div class="card-body p-3">
                  <!-- Sección 1: Datos Básicos y Margen del Producto -->
                  <h6 class="text-primary fw-bold mb-3 small text-uppercase" style="letter-spacing: 0.5px;">
                    <i class="bi bi-box-seam me-2"></i>Datos del Producto
                  </h6>
                  <div class="row g-3 mb-4">
                    <!-- Existencia -->
                    <div class="col-6 col-sm-4 col-md-2">
                      <label class="form-label small text-muted mb-1 fw-semibold">Existencia</label>
                      <div class="input-group input-group-sm bg-white rounded border">
                        <input type="text" class="form-control fw-bold text-end border-0 bg-transparent" readonly [value]="formatNumber(existenciatxt)">
                      </div>
                    </div>
                    <!-- Medida -->
                    <div class="col-6 col-sm-4 col-md-2">
                      <label class="form-label small text-muted mb-1 fw-semibold">Medida</label>
                      <div class="input-group input-group-sm bg-white rounded border">
                        <input type="text" class="form-control form-control-sm fw-bold text-center border-0 bg-transparent" readonly [(ngModel)]="medidatxt">
                      </div>
                    </div>
                    <!-- Fecha Actualización -->
                    <div class="col-6 col-sm-4 col-md-2">
                      <label class="form-label small text-muted mb-1 fw-semibold">Actualizado</label>
                      <div class="input-group input-group-sm bg-white rounded border">
                        <input type="text" class="form-control form-control-sm fw-bold text-center border-0 bg-transparent" readonly [(ngModel)]="fecacttxt">
                      </div>
                    </div>
                    <!-- Costo -->
                    <div class="col-6 col-sm-4 col-md-3">
                      <label class="form-label small text-muted mb-1 fw-semibold">Costo</label>
                      <div class="input-group input-group-sm bg-white rounded border">
                        <span class="input-group-text border-0 bg-transparent text-muted">$</span>
                        <input type="text" class="form-control fw-bold text-end border-0 bg-transparent" readonly [value]="formatNumber(costotxt)">
                      </div>
                    </div>
                    <!-- Margen Producto -->
                    <div class="col-6 col-sm-4 col-md-3">
                      <label class="form-label small text-muted mb-1 fw-semibold">Margen Actual</label>
                      <div class="input-group input-group-sm bg-white rounded border">
                        <input type="text" class="form-control fw-bold text-end border-0 bg-transparent" readonly
                          [value]="formatNumber(protxt) + '%'"
                          [ngStyle]="{'color': protxt < 10 ? '#dc3545' : '#198754'}">
                      </div>
                    </div>
                  </div>

                  <!-- Sección 2: Márgenes de Venta Sugeridos -->
                  <h6 class="text-secondary fw-bold mb-3 small text-uppercase border-top pt-3" style="letter-spacing: 0.5px;">
                    <i class="bi bi-graph-up-arrow me-2"></i>Precios Sugeridos según Margen
                  </h6>
                  <div class="d-flex flex-wrap gap-2 justify-content-between">
                    <!-- 5% -->
                    <div class="border rounded px-2 py-2 bg-white text-center flex-fill shadow-sm" style="min-width: 85px;">
                      <div class="small text-muted fw-bold mb-1">5%</div>
                      <div class="fw-bold text-dark">{{formatNumber(atxt)}}</div>
                    </div>
                    <!-- 7% -->
                    <div class="border rounded px-2 py-2 bg-white text-center flex-fill shadow-sm" style="min-width: 85px;">
                      <div class="small text-muted fw-bold mb-1">7%</div>
                      <div class="fw-bold text-dark">{{formatNumber(btxt)}}</div>
                    </div>
                    <!-- 10% -->
                    <div class="border rounded px-2 py-2 bg-white text-center flex-fill shadow-sm" style="min-width: 85px;">
                      <div class="small text-muted fw-bold mb-1">10%</div>
                      <div class="fw-bold text-dark">{{formatNumber(ctxt)}}</div>
                    </div>
                    <!-- 12% -->
                    <div class="border rounded px-2 py-2 bg-white text-center flex-fill shadow-sm" style="min-width: 85px;">
                      <div class="small text-muted fw-bold mb-1">12%</div>
                      <div class="fw-bold text-dark">{{formatNumber(dtxt)}}</div>
                    </div>
                    <!-- 14% -->
                    <div class="border rounded px-2 py-2 bg-white text-center flex-fill shadow-sm" style="min-width: 85px;">
                      <div class="small text-muted fw-bold mb-1">14%</div>
                      <div class="fw-bold text-dark">{{formatNumber(etxt)}}</div>
                    </div>
                    <!-- 16% -->
                    <div class="border rounded px-2 py-2 bg-white text-center flex-fill shadow-sm" style="min-width: 85px;">
                      <div class="small text-muted fw-bold mb-1">16%</div>
                      <div class="fw-bold text-dark">{{formatNumber(ftxt)}}</div>
                    </div>
                    <!-- 18% -->
                    <div class="border rounded px-2 py-2 bg-white text-center flex-fill shadow-sm" style="min-width: 85px;">
                      <div class="small text-muted fw-bold mb-1">18%</div>
                      <div class="fw-bold text-dark">{{formatNumber(gtxt)}}</div>
                    </div>
                     <!-- 20% -->
                     <div class="border rounded px-2 py-2 bg-white text-center flex-fill shadow-sm" style="min-width: 85px;">
                      <div class="small text-muted fw-bold mb-1">20%</div>
                      <div class="fw-bold text-dark">{{formatNumber(htxt)}}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Columna Derecha: Totales -->
            <div class="col-lg-4 col-xl-4">
              <div class="card border-success shadow-sm h-100" style="border-radius: 12px">
                <div class="card-header bg-success text-white py-2">
                  <h6 class="mb-0 fw-bold small"><i class="bi bi-calculator me-2"></i>Totales Factura</h6>
                </div>
                <div class="card-body bg-light p-3 d-flex flex-column justify-content-center">
                  <!-- Subtotal -->
                  <div class="row mb-2 align-items-center">
                    <div class="col-4">
                      <span class="small fw-semibold text-muted">Sub-Total</span>
                    </div>
                    <div class="col-8">
                      <input type="text" class="form-control form-control-sm fw-bold text-end border-0 bg-transparent p-0 w-100" readonly [(ngModel)]="subtotaltxt">
                    </div>
                  </div>
                  <!-- Descuento -->
                  <div class="row mb-2 align-items-center">
                    <div class="col-4">
                      <span class="small fw-semibold text-muted">Descuento</span>
                    </div>
                    <div class="col-8">
                      <input type="text" class="form-control form-control-sm fw-bold text-end text-danger border-0 bg-transparent p-0 w-100" readonly [(ngModel)]="descuentotxt">
                    </div>
                  </div>
                  <!-- ITBIS -->
                  <div class="row mb-3 align-items-center border-bottom pb-2">
                    <div class="col-4">
                      <span class="small fw-semibold text-muted">ITBIS</span>
                    </div>
                    <div class="col-8">
                      <input type="text" class="form-control form-control-sm fw-bold text-end border-0 bg-transparent p-0 w-100" readonly [(ngModel)]="itbitxt">
                    </div>
                  </div>

                  <!-- Total General -->
                  <div class="row mb-3 align-items-center">
                    <div class="col-4">
                      <span class="h6 fw-bold text-dark mb-0">Total</span>
                    </div>
                    <div class="col-8">
                      <input type="text" class="form-control fw-bold text-end text-success border-0 bg-transparent p-0 fs-4 w-100" readonly [(ngModel)]="totalgraltxt">
                    </div>
                  </div>

                  <!-- Margen Factura Global -->
                   <div class="alert alert-white border d-flex justify-content-between align-items-center p-2 mb-0 mt-2 shadow-sm">
                      <span class="small fw-bold text-muted">Margen Global</span>
                      <span class="badge rounded-pill" [ngStyle]="{'background-color': factxt < 10 ? '#dc3545' : '#198754'}">{{formatNumber(factxt)}}%</span>
                   </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row g-3 mt-2"></div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Búsqueda de Facturas -->
<div
  class="modal fade"
  id="modalBuscarFactura"
  tabindex="-1"
  aria-labelledby="modalBuscarFacturaLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header text-white" style="background: linear-gradient(90deg, #0d6efd, #6610f2)">
        <h5 class="modal-title fw-semibold" id="modalBuscarFacturaLabel">
          <i class="bi bi-search me-2"></i>Buscar Factura
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <!-- Filtros de búsqueda -->
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label small text-muted fw-semibold"
              >No. Factura</label
            >
            <input
              type="text"
              [(ngModel)]="txtFactura"
              placeholder="Buscar por número..."
              class="form-control"
              (input)="buscaFactura($event)"
            />
          </div>
          <div class="col-md-5">
            <label class="form-label small text-muted fw-semibold"
              >Nombre Cliente</label
            >
            <input
              type="text"
              [(ngModel)]="txtdescripcion"
              placeholder="Buscar por cliente..."
              class="form-control text-uppercase"
              (input)="buscaNombre($event)"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted fw-semibold">Fecha</label>
            <input type="date" [(ngModel)]="txtFecha" class="form-control" />
          </div>
        </div>

        <!-- Tabla de Facturas -->
        <div
          class="table-responsive"
          style="max-height: 400px; overflow-y: auto"
        >
          <table class="table table-hover align-middle mb-0">
            <thead class="table-dark sticky-top">
              <tr>
                <th style="width: 15%">Número</th>
                <th style="width: 40%">Cliente</th>
                <th class="text-center" style="width: 15%">Fecha</th>
                <th class="text-end" style="width: 20%">Valor</th>
                <th class="text-center" style="width: 10%">Acción</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let factura of facturacionList" class="border-bottom">
                <td class="fw-semibold text-primary">{{factura.fa_codFact}}</td>
                <td>{{factura.fa_nomClie}}</td>
                <td class="text-center">{{ formatFecha(factura.fa_fecFact) }}</td>
                <td class="text-end fw-semibold">{{factura.fa_valFact}}</td>
                <td class="text-center">
                  <button
                    class="btn btn-outline-success btn-sm"
                    (click)="consultarFacturacion(factura)"
                    data-bs-dismiss="modal"
                    title="Cargar factura"
                  >
                    <i class="bi bi-check-circle me-1"></i>Seleccionar
                  </button>
                </td>
              </tr>
              <tr *ngIf="facturacionList.length === 0">
                <td colspan="5" class="text-center text-muted py-4">
                  <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                  No se encontraron facturas
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
